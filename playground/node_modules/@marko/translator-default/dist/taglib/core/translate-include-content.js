"use strict";var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");exports.__esModule = true;exports.enter = enter;var _babelUtils = require("@marko/babel-utils");
var _compiler = require("@marko/compiler");
var _path = _interopRequireDefault(require("path"));

function enter(tag) {
  const {
    hub: { file }
  } = tag;
  (0, _babelUtils.assertNoParams)(tag);
  (0, _babelUtils.assertNoAttributes)(tag);

  const fs = file.markoOpts.fileSystem;
  const tagName = tag.get("name").node.value;
  const tagExample = `<${tagName}("./path-to-file.ext")>`;
  const args = tag.get("arguments");

  if (args.length !== 1) {
    throw tag.buildCodeFrameError(
      `A single path argument is required for ${tagExample}.`
    );
  }

  const [content] = args;

  if (!content.isStringLiteral()) {
    throw content.buildCodeFrameError(
      `The argument to ${tagExample} must be a static string.`
    );
  }

  const dir = _path.default.dirname(file.opts.filename);
  const fullPath = _path.default.resolve(dir, content.node.value);

  try {
    const stat = fs.statSync(fullPath);

    if (!stat.isFile()) {
      throw new Error();
    }
  } catch {
    throw content.buildCodeFrameError(`Unable to find file for <${tagName}>.`);
  }

  tag.replaceWith(
    _compiler.types.markoPlaceholder(
      _compiler.types.stringLiteral(fs.readFileSync(fullPath).toString("utf-8")),
      tagName === "include-text"
    )
  );
}